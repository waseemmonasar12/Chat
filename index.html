<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…Ø´ÙØ±Ø© ğŸ”</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; height: 100vh; }
        .app-container { width: 100%; max-width: 500px; background: #fff; display: flex; flex-direction: column; height: 100%; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header { background: #075e54; color: white; padding: 15px; text-align: center; font-size: 1.2em; font-weight: bold; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen { padding: 20px; text-align: center; background: white; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; display: flex; flex-direction: column; justify-content: center; gap: 15px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { background: #25D366; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-box { flex: 1; padding: 15px; overflow-y: auto; background: #e5ddd5; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 80%; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .me { background: #dcf8c6; align-self: flex-end; }
        .other { background: #fff; align-self: flex-start; }
        .sender { font-size: 11px; color: #075e54; font-weight: bold; display: block; margin-bottom: 4px; }

        .input-area { padding: 10px; background: #f0f0f0; display: flex; gap: 8px; }
        #messageInput { flex: 1; border-radius: 20px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="login-screen">
            <h2>ğŸ” Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</h2>
            <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            <input type="password" id="chatPassword" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØªØ´ÙÙŠØ± (Ù„Ù„Ø¹Ø§Ø¦Ù„Ø© ÙÙ‚Ø·)">
            <p style="font-size: 12px; color: #666;">* ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„ØªÙŠ Ø³ØªÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.</p>
            <button onclick="startApp()">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <header>Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…Ø´ÙØ±Ø©</header>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù…Ø´ÙØ±Ø©...">
            <button onclick="sendEncryptedMessage()">â¤</button>
        </div>
    </div>

    <script>
        // 1. Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Firebase Ù‡Ù†Ø§ (ÙƒÙ…Ø§ ÙØ¹Ù„Ù†Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
        const firebaseConfig = {
            apiKey: "AIzaSy...", 
            authDomain: "chat-9c623.firebaseapp.com",
            databaseURL: "https://chat-9c623-default-rtdb.firebaseio.com",
            projectId: "chat-9c623",
            storageBucket: "chat-9c623.appspot.com",
            messagingSenderId: "858118572582",
            appId: "1:858118572582:web:979ef639fed422a22ff4e7"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let myName = "";
        let encryptionKey = "";

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ´ÙÙŠØ± Ù…Ù† Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø«Ø§Ù†ÙŠ ---
        const uint8ToBase64 = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
        const base64ToUint8 = (str) => new Uint8Array(atob(str).split('').map(c => c.charCodeAt(0)));

        async function encryptData(text, password) {
            const encoder = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const keyMaterial = await crypto.subtle.importKey("raw", encoder.encode(password), {name: "PBKDF2"}, false, ["deriveKey"]);
            const aesKey = await crypto.subtle.deriveKey({name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256"}, keyMaterial, {name: "AES-GCM", length: 256}, false, ["encrypt"]);
            const encrypted = await crypto.subtle.encrypt({name: "AES-GCM", iv}, aesKey, encoder.encode(text));
            const result = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
            result.set(salt, 0); result.set(iv, salt.length); result.set(new Uint8Array(encrypted), salt.length + iv.length);
            return uint8ToBase64(result);
        }

 async function decryptData(cipherB64, password) {
    try {
        const bytes = base64ToUint8(cipherB64);
        const salt = bytes.slice(0, 16); 
        const iv = bytes.slice(16, 28); 
        const data = bytes.slice(28);
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey("raw", encoder.encode(password), {name: "PBKDF2"}, false, ["deriveKey"]);
        const aesKey = await crypto.subtle.deriveKey({name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256"}, keyMaterial, {name: "AES-GCM", length: 256}, false, ["decrypt"]);
        const decrypted = await crypto.subtle.decrypt({name: "AES-GCM", iv}, aesKey, data);
        return new TextDecoder().decode(decrypted);
    } catch (e) { 
        return "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"; 
    }
}


        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        function startApp() {
            myName = document.getElementById("username").value;
            encryptionKey = document.getElementById("chatPassword").value;
            if (myName && encryptionKey) {
                document.getElementById("login-screen").style.display = "none";
                listenForMessages();
            } else { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"); }
        }

        async function sendEncryptedMessage() {
            const input = document.getElementById("messageInput");
            if (input.value.trim() === "") return;
            const encrypted = await encryptData(input.value, encryptionKey);
            database.ref("messages").push().set({ sender: myName, text: encrypted });
            input.value = "";
        }

        function listenForMessages() {
            database.ref("messages").on("child_added", async (snapshot) => {
                const data = snapshot.val();
                const decryptedText = await decryptData(data.text, encryptionKey);
                const chatBox = document.getElementById("chatBox");
                const div = document.createElement("div");
                div.className = `msg ${data.sender === myName ? 'me' : 'other'}`;
                div.innerHTML = `<span class="sender">${data.sender}</span>${decryptedText}`;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }
    </script>
</body>
</html>

