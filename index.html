<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Secure ğŸ”</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00a884;
            --secondary: #005c4b;
            --bg-glass: rgba(10, 20, 30, 0.85); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© ÙˆØ´ÙØ§ÙØ© */
            --msg-me: #005c4b;
            --msg-other: #202c33;
            --text-light: #e9edef;
            --text-gray: #cfd8dc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© */
            background-image: url('https://raw.githubusercontent.com/waseemmonasar12/Chat/f0981b25071c7ed7b1471a094327f9dea9e401fc/Aobida.jpeg'); 
            background-size: cover; background-position: center;
            color: var(--text-light);
            display: flex; justify-content: center; align-items: center;
        }

        /* ØªØ¹ØªÙŠÙ… Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø¨Ø±ÙˆØ² Ø§Ù„Ù†ØµÙˆØµ */
        body::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.4); z-index: -1; backdrop-filter: blur(3px);
        }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .app-container {
            width: 100%; height: 100%; max-width: 1400px;
            background: var(--bg-glass);
            display: flex; position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        @media (min-width: 768px) {
            .app-container { height: 90vh; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .full-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }

        .hidden { display: none !important; }

        input, button, textarea {
            width: 100%; padding: 15px; margin: 10px 0;
            border-radius: 10px; border: 1px solid #444;
            background: rgba(40, 50, 60, 0.8); color: white; outline: none;
            font-family: 'Cairo', sans-serif; font-size: 16px;
        }

        button { background: var(--primary); border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #008f6f; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            border-left: 1px solid rgba(255,255,255,0.1);
            background: rgba(17, 27, 33, 0.8);
            transition: transform 0.3s ease;
            position: absolute; z-index: 10;
        }
        
        @media (min-width: 768px) { 
            .sidebar { width: 380px; position: relative; transform: none !important; } 
        }

        .sidebar-header {
            padding: 15px; background: rgba(32, 44, 51, 0.9); 
            display: flex; justify-content: space-between; align-items: center;
        }

        /* ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        .avatar-img {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--primary);
        }
        .default-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: #555;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« */
        .tabs { display: flex; background: rgba(0,0,0,0.2); }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #aaa; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); font-weight: bold; }
        
        .list-container { flex: 1; overflow-y: auto; padding: 10px; }

        .item-card {
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;
            display: flex; align-items: center; gap: 15px; border-radius: 8px;
            transition: 0.2s;
        }
        .item-card:hover { background: rgba(255,255,255,0.1); }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª */
        .chat-area { 
            flex: 1; display: flex; flex-direction: column; background: transparent; 
            width: 100%; height: 100%; position: absolute; z-index: 20;
            background: rgba(10, 20, 30, 0.95); /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø§Øª Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØ¯Ø§Ø®Ù„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            transform: translateX(-100%); /* Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            transition: transform 0.3s ease;
        }

        @media (min-width: 768px) {
            .chat-area { position: relative; transform: none !important; background: transparent; }
        }

        /* Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø´Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .chat-active .chat-area { transform: translateX(0); }
        .chat-active .sidebar { display: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø´Ø§Øª */
        
        @media (min-width: 768px) {
            .chat-active .sidebar { display: flex; } /* Ø¥Ø¹Ø§Ø¯ØªÙ‡ ÙÙŠ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ */
        }

        .chat-header {
            padding: 10px 15px; background: rgba(32, 44, 51, 0.9); 
            display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }

        .msg {
            max-width: 85%; padding: 8px 12px; border-radius: 12px;
            position: relative; word-wrap: break-word; font-size: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .msg.me { background: var(--msg-me); align-self: flex-end; border-top-left-radius: 0; }
        .msg.other { background: var(--msg-other); align-self: flex-start; border-top-right-radius: 0; }
        .msg-sender { font-size: 11px; color: #00ffcc; font-weight: bold; display: block; margin-bottom: 3px; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .input-area { padding: 10px; background: rgba(32, 44, 51, 0.95); display: flex; align-items: center; gap: 8px; }
        .icon-btn {
            background: transparent; width: 40px; height: 40px; border: none; font-size: 18px; color: #ccc;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        /* Ø§Ù„Ø­Ù‚ÙˆÙ‚ */
        .copyright {
            position: absolute; bottom: 5px; width: 100%; text-align: center;
            font-size: 12px; color: rgba(255,255,255,0.4); pointer-events: none; z-index: 1000;
        }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #202c33; padding: 20px; border-radius: 15px;
            width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--primary);
        }
        
        /* Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        .profile-preview {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            margin: 10px auto; border: 3px solid var(--primary); display: block;
        }
    </style>
</head>
<body>

    <div class="copyright">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Ø£Ø¨ÙˆÙ…Ø­Ù…Ø¯</div>

    <div id="auth-screen" class="full-screen">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ›¡ï¸</div>
        <h2>Chat Secure</h2>
        <input type="text" id="usernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <button onclick="checkAndLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <p id="loginError" style="color: #f15c6d; font-size: 14px; margin-top: 10px;"></p>
    </div>

    <div id="app-dashboard" class="app-container hidden">
        
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="openProfileSettings()">
                    <img id="myAvatarImg" src="" class="avatar-img hidden">
                    <div id="myDefaultAvatar" class="default-avatar hidden">ğŸ‘¤</div>
                    <div style="text-align: right;">
                        <span id="myNameDisplay" style="font-weight: bold; display:block;"></span>
                        <small style="color:var(--primary); font-size:10px;">Ø§Ø¶ØºØ· Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</small>
                    </div>
                </div>
                <div>
                    <button class="icon-btn" onclick="openProfileSettings()" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"><i class="fas fa-cog"></i></button>
                    <button class="icon-btn" onclick="showCreateRoom()" title="Ù‚Ø±ÙˆØ¨ Ø¬Ø¯ÙŠØ¯"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div style="padding:10px;">
                <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterList()" style="padding:10px; border-radius:20px; background:rgba(0,0,0,0.3); border:none;">
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('rooms')" id="tab-rooms">Ù‚Ø±ÙˆØ¨Ø§Øª ğŸ‘¥</div>
                <div class="tab" onclick="switchTab('users')" id="tab-users">Ø£Ø´Ø®Ø§Øµ ğŸ‘¤</div>
            </div>

            <div id="roomsList" class="list-container"></div>
            <div id="usersList" class="list-container hidden"></div>
        </div>

        <div id="chatArea" class="chat-area">
            <div class="chat-header">
                <button class="icon-btn" onclick="closeChatMobile()" style="font-size: 18px;"><i class="fas fa-arrow-right"></i></button>
                <img id="headerChatImg" class="avatar-img hidden" style="width:35px;height:35px;">
                <div style="display:flex; flex-direction:column;">
                    <div id="currentRoomName" style="font-weight: bold;">Ù…Ø­Ø§Ø¯Ø«Ø©</div>
                    <small style="color:var(--text-gray); font-size:10px;">Ù…Ø´ÙØ± ğŸ”’</small>
                </div>
            </div>

            <div id="messagesContainer" class="messages-container"></div>
            
            <div class="input-area">
                <label class="icon-btn"><i class="fas fa-camera"></i><input type="file" id="imgInput" hidden onchange="sendImage(this)"></label>
                <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button class="icon-btn" onclick="sendText()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="emptyState" class="full-screen" style="z-index: 5; background: transparent; pointer-events: none;">
            </div>
    </div>

    <div id="profileModal" class="modal hidden">
        <div class="modal-content">
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            
            <label for="profilePicInput" style="cursor:pointer;">
                <img id="previewProfilePic" src="https://via.placeholder.com/100" class="profile-preview">
                <small style="color:var(--primary);">Ø§Ø¶ØºØ· Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</small>
            </label>
            <input type="file" id="profilePicInput" hidden onchange="previewImage(this)">
            
            <input type="text" id="profileBioInput" placeholder="Ø§ÙƒØªØ¨ Ø®Ø¨Ø±Ø§Ù‹ Ø¹Ù†Ùƒ (Bio)...">
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="saveProfile()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" style="background:#333;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
            <button onclick="logout()" style="background:var(--delete-red); margin-top:10px;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="createRoomModal" class="modal hidden">
        <div class="modal-content">
            <h3>Ù‚Ø±ÙˆØ¨ Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="newRoomName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <select id="roomType" style="margin:10px 0; padding:10px; width:100%; border-radius:10px; background:#2a3942; color:white;">
                <option value="public">Ø¹Ø§Ù…</option>
                <option value="private">Ø®Ø§Øµ</option>
            </select>
            <input type="password" id="newRoomPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <button onclick="createRoom()">Ø¥Ù†Ø´Ø§Ø¡</button>
            <button onclick="document.getElementById('createRoomModal').classList.add('hidden')" style="background:#333;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="passModal" class="modal hidden">
        <div class="modal-content">
            <h3>ğŸ”’ Ù…Ø­Ù…ÙŠ</h3>
            <input type="password" id="joinPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <button onclick="joinPrivateRoom()">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="document.getElementById('passModal').classList.add('hidden')" style="background:#333;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        // --- 1. Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyACnX1Xu-2XiyxYtGT_wUzfMqVcUddVxKs",
          authDomain: "chat-9c623.firebaseapp.com",
          databaseURL: "https://chat-9c623-default-rtdb.firebaseio.com",
          projectId: "chat-9c623",
          storageBucket: "chat-9c623.firebasestorage.app",
          messagingSenderId: "858118572582",
          appId: "1:858118572582:web:979ef639fed422a22ff4e7",
          measurementId: "G-THT2B1RYEK"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = localStorage.getItem('chatUser') || "";
        let currentChatId = null;
        let currentKey = null;
        let tempRoomData = null;

        // --- Ø§Ù„ØªØ´ÙÙŠØ± ---
        const uint8ToBase64 = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
        const base64ToUint8 = (str) => new Uint8Array(atob(str).split('').map(c => c.charCodeAt(0)));
        async function encryptPacket(dataObj, password) {
            const jsonStr = JSON.stringify(dataObj);
            const enc = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const keyMat = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
            const key = await crypto.subtle.deriveKey({name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256"}, keyMat, {name: "AES-GCM", length: 256}, false, ["encrypt"]);
            const encrypted = await crypto.subtle.encrypt({name: "AES-GCM", iv}, key, enc.encode(jsonStr));
            const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
            combined.set(salt); combined.set(iv, salt.length); combined.set(new Uint8Array(encrypted), salt.length + iv.length);
            return uint8ToBase64(combined);
        }
        async function decryptPacket(cipherStr, password) {
            try {
                const bytes = base64ToUint8(cipherStr);
                const salt = bytes.slice(0, 16);
                const iv = bytes.slice(16, 28);
                const data = bytes.slice(28);
                const enc = new TextEncoder();
                const keyMat = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
                const key = await crypto.subtle.deriveKey({name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256"}, keyMat, {name: "AES-GCM", length: 256}, false, ["decrypt"]);
                const decrypted = await crypto.subtle.decrypt({name: "AES-GCM", iv}, key, data);
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch(e) { return null; }
        }

        // --- Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ---
        if(myName) initApp();

        async function checkAndLogin() {
            const name = document.getElementById('usernameInput').value.trim();
            if(name.length < 3) return;
            
            const snapshot = await db.ref('users/' + name).once('value');
            if (snapshot.exists()) {
                // Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ØŒ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
                // (ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ ÙŠØ¬Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±ØŒ Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ· Ø³Ù†Ø³Ù…Ø­ Ø¨Ù‡)
            } else {
                // ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                await db.ref('users/' + name).set({ bio: "Ù…ØªØ§Ø­", joinedAt: Date.now() });
            }
            
            myName = name;
            localStorage.setItem('chatUser', myName);
            initApp();
        }

        function initApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-dashboard').classList.remove('hidden');
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ
            db.ref('users/' + myName).on('value', snap => {
                const data = snap.val();
                document.getElementById('myNameDisplay').innerText = myName;
                updateAvatarUI('myAvatarImg', 'myDefaultAvatar', data?.profileImage);
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                document.getElementById('profileBioInput').value = data?.bio || "";
                if(data?.profileImage) document.getElementById('previewProfilePic').src = data.profileImage;
            });

            setupListeners();
        }

        function logout() {
            localStorage.removeItem('chatUser');
            location.reload();
        }

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ---
        function openProfileSettings() { document.getElementById('profileModal').classList.remove('hidden'); }
        
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('previewProfilePic').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveProfile() {
            const bio = document.getElementById('profileBioInput').value;
            const imgSrc = document.getElementById('previewProfilePic').src;
            
            // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¬Ø¯ÙŠØ¯Ø©
            let finalImg = imgSrc.includes("via.placeholder") ? null : imgSrc;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© Base64 Ø·ÙˆÙŠÙ„Ø©ØŒ ÙŠÙØ¶Ù„ Ø¶ØºØ·Ù‡Ø§ (ØªØ¬Ø§ÙˆØ²Ù†Ø§ Ø°Ù„Ùƒ Ù„Ù„ØªØ¨Ø³ÙŠØ·)
            await db.ref('users/' + myName).update({
                bio: bio,
                profileImage: finalImg
            });
            document.getElementById('profileModal').classList.add('hidden');
        }

        function updateAvatarUI(imgId, divId, imgUrl) {
            const imgEl = document.getElementById(imgId);
            const divEl = document.getElementById(divId);
            if(imgUrl) {
                imgEl.src = imgUrl; imgEl.classList.remove('hidden');
                divEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden'); divEl.classList.remove('hidden');
            }
        }

        // --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…ØªØ¬Ø§ÙˆØ¨) ---
        function setupListeners() {
            // Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª
            db.ref('rooms').on('value', snapshot => {
                const list = document.getElementById('roomsList');
                list.innerHTML = "";
                const data = snapshot.val();
                if(data) Object.keys(data).forEach(key => renderRoomItem(key, data[key], list));
            });

            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù„Ø®Ø§Øµ)
            db.ref('users').on('value', snapshot => {
                const list = document.getElementById('usersList');
                list.innerHTML = "";
                const data = snapshot.val();
                if(data) {
                    Object.keys(data).forEach(key => {
                        if(key !== myName) renderUserItem(key, data[key], list);
                    });
                }
            });
        }

        function renderRoomItem(key, r, list) {
            const div = document.createElement('div');
            div.className = 'item-card';
            div.setAttribute('data-name', r.name);
            div.innerHTML = `
                <div class="default-avatar" style="background:var(--secondary)">${r.type=='private'?'ğŸ”’':'ğŸ‘¥'}</div>
                <div><div style="font-weight:bold">${r.name}</div><small style="color:gray">${r.type=='private'?'Ø®Ø§Øµ':'Ø¹Ø§Ù…'}</small></div>
            `;
            div.onclick = () => checkRoom(key, r);
            list.appendChild(div);
        }

        function renderUserItem(key, user, list) {
            const div = document.createElement('div');
            div.className = 'item-card';
            div.setAttribute('data-name', key);
            
            const hasImg = user.profileImage ? true : false;
            const imgHtml = hasImg ? `<img src="${user.profileImage}" class="avatar-img">` : `<div class="default-avatar">ğŸ‘¤</div>`;
            
            div.innerHTML = `
                ${imgHtml}
                <div>
                    <div style="font-weight:bold">${key}</div>
                    <small style="color:#aaa">${user.bio || "Ù…ØªØ§Ø­"}</small>
                </div>
            `;
            div.onclick = () => startDirectChat(key);
            list.appendChild(div);
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ---
        function openChatMobile() {
            document.body.classList.add('chat-active');
            document.getElementById('emptyState').style.display = 'none';
        }

        function closeChatMobile() {
            document.body.classList.remove('chat-active');
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ù‡
            if(window.innerWidth >= 768) document.getElementById('emptyState').style.display = 'flex';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('roomsList').classList.toggle('hidden', tab !== 'rooms');
            document.getElementById('usersList').classList.toggle('hidden', tab !== 'users');
        }

        function filterList() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.item-card').forEach(item => {
                item.style.display = item.getAttribute('data-name').toLowerCase().includes(term) ? 'flex' : 'none';
            });
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØºØ±Ù ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
        function showCreateRoom() { document.getElementById('createRoomModal').classList.remove('hidden'); }
        function createRoom() {
            const name = document.getElementById('newRoomName').value;
            const type = document.getElementById('roomType').value;
            const pass = document.getElementById('newRoomPass').value;
            if(!name) return;
            const finalPass = type === 'public' ? 'PUBLIC_KEY' : pass;
            db.ref('rooms').push({ name, type, password: finalPass });
            document.getElementById('createRoomModal').classList.add('hidden');
        }

        function checkRoom(id, room) {
            if(room.type === 'public') enterChat(id, room.name, 'PUBLIC_KEY');
            else { tempRoomData = {id, room}; document.getElementById('passModal').classList.remove('hidden'); }
        }
        function joinPrivateRoom() {
            if(document.getElementById('joinPass').value === tempRoomData.room.password) {
                enterChat(tempRoomData.id, tempRoomData.room.name, tempRoomData.room.password);
                document.getElementById('passModal').classList.add('hidden');
            } else alert("Ø®Ø·Ø£");
        }
        
        function startDirectChat(otherUser) {
            const chatId = [myName, otherUser].sort().join('_');
            enterChat(chatId, otherUser, 'DM_KEY_' + chatId);
        }

        function enterChat(id, title, key) {
            currentChatId = id; currentKey = key;
            document.getElementById('currentRoomName').innerText = title;
            document.getElementById('messagesContainer').innerHTML = "";
            openChatMobile(); // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            db.ref('messages/' + id).off();
            db.ref('messages/' + id).limitToLast(50).on('child_added', async snap => {
                const packet = await decryptPacket(snap.val().data, key);
                if(packet) renderMessage(packet);
            });
        }

        function renderMessage(packet) {
            const div = document.createElement('div');
            div.className = `msg ${packet.sender === myName ? 'me' : 'other'}`;
            let content = `<span class="msg-sender">${packet.sender}</span>`;
            if(packet.type === 'text') content += `<span>${packet.content}</span>`;
            else if(packet.type === 'image') content += `<img src="${packet.content}" class="msg-img" onclick="window.open(this.src)">`;
            div.innerHTML = content;
            const container = document.getElementById('messagesContainer');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function sendText() {
            const inp = document.getElementById('msgInput');
            if(inp.value.trim() && currentChatId) {
                const packet = { sender: myName, content: inp.value, type: 'text', timestamp: Date.now() };
                const enc = await encryptPacket(packet, currentKey);
                db.ref('messages/' + currentChatId).push({ data: enc });
                inp.value = "";
            }
        }
        
        function sendImage(input) {
            if(input.files[0] && currentChatId) {
                const reader = new FileReader();
                reader.onload = async e => {
                    const packet = { sender: myName, content: e.target.result, type: 'image', timestamp: Date.now() };
                    const enc = await encryptPacket(packet, currentKey);
                    db.ref('messages/' + currentChatId).push({ data: enc });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</body>
</html>
